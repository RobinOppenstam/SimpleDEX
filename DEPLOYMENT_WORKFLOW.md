# SimpleDex Deployment Workflow

## Overview

SimpleDex now supports **fully automated deployment** to both Anvil (local) and Sepolia (testnet) with **automatic frontend configuration updates**. You no longer need to manually update any configuration files!

---

## Quick Start

### Deploy to Anvil (Local Development)

```bash
# Terminal 1: Start Anvil
anvil

# Terminal 2: Deploy contracts (auto-updates frontend)
cd contracts
./startup.sh

# Terminal 3: Start frontend
cd ../dex-frontend
npm run dev

# Open browser: http://localhost:3000
# Connect MetaMask to "Localhost 8545"
```

**Done!** The frontend is automatically configured with Anvil addresses.

---

### Deploy to Sepolia (Testnet)

```bash
# One-time setup: Configure .env
cd contracts
cp .env.example .env
# Edit .env and add:
#   SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY
#   SEPOLIA_PRIVATE_KEY=your_private_key
#   ETHERSCAN_API_KEY=your_api_key

# Deploy contracts (auto-updates frontend)
./startup-sepolia.sh

# Start frontend (in another terminal)
cd ../dex-frontend
npm run dev

# Open browser: http://localhost:3000
# Connect MetaMask to "Sepolia"
```

**Done!** The frontend is automatically configured with Sepolia addresses.

---

## What Happens Automatically

### During Anvil Deployment (`./startup.sh`)

1. âœ… Deploys all contracts to Anvil
2. âœ… Saves addresses to `contracts/.env`
3. âœ… **Automatically runs:** `python3 update-frontend-config.py anvil`
4. âœ… Updates `dex-frontend/.env.local` with Anvil addresses
5. âœ… Updates TypeScript files (tokens.ts, priceFeeds.ts, page.tsx)

**Result:** Frontend is ready to use with Anvil!

### During Sepolia Deployment (`./startup-sepolia.sh`)

1. âœ… Deploys all contracts to Sepolia
2. âœ… Deploys real Chainlink price feeds
3. âœ… Verifies contracts on Etherscan
4. âœ… Saves addresses to `contracts/.env`
5. âœ… **Automatically runs:** `python3 update-frontend-config.py sepolia`
6. âœ… Updates `dex-frontend/.env.local` with Sepolia addresses (preserves Anvil addresses)

**Result:** Frontend is ready to use with Sepolia!

---

## How Frontend Detects Network

The frontend uses the `useNetwork()` hook which:

1. **Reads wallet's connected chain ID**
2. **Loads correct addresses** from `.env.local`:
   - Chain ID 31337 (Anvil) â†’ Uses `NEXT_PUBLIC_FACTORY_ADDRESS`
   - Chain ID 11155111 (Sepolia) â†’ Uses `NEXT_PUBLIC_SEPOLIA_FACTORY_ADDRESS`
3. **Adapts price refresh behavior**:
   - Anvil: 0 seconds (no refresh, static prices)
   - Sepolia: 60 seconds (auto-refresh, live Chainlink)

**No manual switching needed!** Just change networks in MetaMask.

---

## File Structure

### Backend (Contracts)

```
contracts/
â”œâ”€â”€ startup.sh                    # Anvil deployment (auto-updates frontend)
â”œâ”€â”€ startup-sepolia.sh           # Sepolia deployment (auto-updates frontend)
â”œâ”€â”€ update-frontend-config.py    # Auto-config script (supports both networks)
â”œâ”€â”€ .env                         # Contract addresses (auto-generated)
â””â”€â”€ script/
    â”œâ”€â”€ DeployPriceFeeds.s.sol       # Mock price feeds (Anvil)
    â””â”€â”€ DeployRealPriceFeeds.s.sol   # Real Chainlink (Sepolia)
```

### Frontend

```
dex-frontend/
â”œâ”€â”€ .env.local                   # Auto-generated by update-frontend-config.py
â”œâ”€â”€ .env.local.example          # Template (for reference)
â””â”€â”€ src/
    â”œâ”€â”€ app/config/
    â”‚   â””â”€â”€ networks.ts          # Network configs (reads from .env.local)
    â”œâ”€â”€ hooks/
    â”‚   â””â”€â”€ useNetwork.ts        # Network detection hook
    â””â”€â”€ components/
        â””â”€â”€ NetworkSwitcher.tsx  # UI component
```

---

## Manual Override (If Needed)

### Update Frontend Config Manually

```bash
cd contracts

# For Anvil
python3 update-frontend-config.py anvil

# For Sepolia
python3 update-frontend-config.py sepolia
```

### Edit .env.local Manually

The auto-generated file preserves your manual edits to non-address fields:

```bash
# dex-frontend/.env.local
NEXT_PUBLIC_DEFAULT_CHAIN_ID=31337  # Change to 11155111 for Sepolia default

# Anvil addresses (auto-updated by startup.sh)
NEXT_PUBLIC_FACTORY_ADDRESS=0x5FbDB...
NEXT_PUBLIC_ROUTER_ADDRESS=0xe7f17...

# Sepolia addresses (auto-updated by startup-sepolia.sh)
NEXT_PUBLIC_SEPOLIA_FACTORY_ADDRESS=0xABCD...
NEXT_PUBLIC_SEPOLIA_ROUTER_ADDRESS=0x1234...
```

---

## Network Switching

### Method 1: Switch in MetaMask

1. Click MetaMask network dropdown
2. Select "Localhost 8545" or "Sepolia"
3. **Frontend auto-detects** and loads correct addresses

### Method 2: Use NetworkSwitcher Component

1. Look for the network indicator at the top of the page
2. Click "Anvil" or "Sepolia" button
3. Approve MetaMask network switch prompt
4. **Frontend auto-updates** with new addresses

---

## Environment Variables Reference

### contracts/.env

```bash
# Auto-generated by deployment scripts
FACTORY_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
ROUTER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
PRICE_ORACLE_ADDRESS=0x68B1D87F95878fE05B998F19b66F4bAbA5De1aed
FAUCET_ADDRESS=0x2279B7A0a67DB372996a5FaB50D91eAA73d2eBe6

# For Sepolia deployment
SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY
SEPOLIA_PRIVATE_KEY=your_private_key
ETHERSCAN_API_KEY=your_api_key
```

### dex-frontend/.env.local

```bash
# Auto-generated by update-frontend-config.py
NEXT_PUBLIC_DEFAULT_CHAIN_ID=31337

# Anvil addresses
NEXT_PUBLIC_ANVIL_RPC_URL=http://127.0.0.1:8545
NEXT_PUBLIC_FACTORY_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
NEXT_PUBLIC_ROUTER_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
NEXT_PUBLIC_PRICE_ORACLE_ADDRESS=0x68B1D87F95878fE05B998F19b66F4bAbA5De1aed
NEXT_PUBLIC_FAUCET_ADDRESS=0x2279B7A0a67DB372996a5FaB50D91eAA73d2eBe6

# Sepolia addresses
NEXT_PUBLIC_SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_KEY
NEXT_PUBLIC_SEPOLIA_FACTORY_ADDRESS=0xYourSepoliaFactory
NEXT_PUBLIC_SEPOLIA_ROUTER_ADDRESS=0xYourSepoliaRouter
NEXT_PUBLIC_SEPOLIA_PRICE_ORACLE_ADDRESS=0xYourSepoliaOracle
NEXT_PUBLIC_SEPOLIA_FAUCET_ADDRESS=0xYourSepoliaFaucet
```

---

## Troubleshooting

### "Contract addresses not found"

**Cause:** `.env.local` not created yet

**Fix:** Run deployment script:
```bash
cd contracts
./startup.sh          # For Anvil
# OR
./startup-sepolia.sh  # For Sepolia
```

### "Unsupported Network" warning

**Cause:** Wallet connected to wrong network

**Fix:** Switch MetaMask to Anvil or Sepolia

### Frontend shows old addresses

**Cause:** Next.js hasn't reloaded `.env.local`

**Fix:**
1. Stop Next.js dev server (Ctrl+C)
2. Restart: `npm run dev`
3. Hard refresh browser (Ctrl+Shift+R)

### Deployment script doesn't update frontend

**Cause:** `update-frontend-config.py` not found or failed

**Fix:**
```bash
cd contracts
python3 update-frontend-config.py anvil    # For Anvil
python3 update-frontend-config.py sepolia  # For Sepolia
```

---

## Complete Workflow Example

### Scenario: Deploy to both networks, test switching

```bash
# Step 1: Deploy to Anvil
cd contracts
anvil &  # Start in background
./startup.sh

# Step 2: Deploy to Sepolia (in another terminal)
cd contracts
./startup-sepolia.sh

# Step 3: Start frontend
cd ../dex-frontend
npm run dev

# Step 4: Test in browser
# - Open http://localhost:3000
# - Connect MetaMask to Localhost 8545
# - See "Anvil | Static prices (for testing)"
# - Switch MetaMask to Sepolia
# - See "Sepolia | âœ“ Live price feeds (updates every 60s)"
# - Done!
```

---

## Key Benefits

âœ… **Zero Manual Configuration** - Deployment scripts handle everything
âœ… **Network Detection** - Frontend automatically adapts to wallet's network
âœ… **Preserved Settings** - Re-deploying preserves other network's addresses
âœ… **Price Feed Awareness** - Different refresh rates for Anvil vs Sepolia
âœ… **User-Friendly** - Network switcher shows current status

---

## Summary

| Action | Command | Auto-Updates Frontend? |
|--------|---------|----------------------|
| Deploy Anvil | `./startup.sh` | âœ… Yes (Anvil addresses) |
| Deploy Sepolia | `./startup-sepolia.sh` | âœ… Yes (Sepolia addresses) |
| Manual Update | `python3 update-frontend-config.py [network]` | âœ… Yes |
| Switch Networks | Change in MetaMask | âœ… Detects automatically |

**You can now deploy to testnet without any manual configuration!** Just run `./startup-sepolia.sh` and the frontend will be ready to use on Sepolia. ðŸš€
